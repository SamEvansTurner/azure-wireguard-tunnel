---
# =============================================================================
# Azure WireGuard Tunnel - Ansible Default Variables
# =============================================================================
#
# These are default values that can be overridden by config.yml
# The deploy.sh script passes config.yml as extra vars (-e @config.yml)
#
# Variable precedence (highest to lowest):
#   1. Extra vars from config.yml (-e @config.yml)
#   2. Inventory host vars
#   3. This file (group_vars/all.yml)
#
# =============================================================================

# =============================================================================
# MAPPING: Config.yml structure to flat Ansible variables
# =============================================================================
# These computed variables map the nested config.yml structure to the flat
# variable names expected by the Ansible roles

# Azure configuration
# Priority: inventory (auto-detected from Terraform) > config.yml > environment variable
# The azure_subscription_id from inventory is passed automatically by deploy.sh
azure_subscription_id: "{{ azure_subscription_id | default(azure.subscription_id | default(lookup('env', 'AZURE_SUBSCRIPTION_ID'))) }}"

# SSH configuration (from config.yml: ssh.*)
admin_user: "{{ ssh.admin_username | default('azureuser') }}"
allowed_ssh_ipv4: "{{ ssh.allowed_ipv4 | default('') | regex_replace('/32$', '') }}"
allowed_ssh_ipv6: "{{ ssh.allowed_ipv6 | default('') | regex_replace('/128$', '') }}"

# Domain configuration (from config.yml: domain.*)
domain_name: "{{ domain.name | default('') }}"
subdomain: "{{ domain.subdomain | default('*') }}"
desec_token: "{{ domain.desec_token | default(lookup('env', 'DESEC_TOKEN')) }}"

# WireGuard configuration (from config.yml: wireguard.*)
wireguard_port: "{{ wireguard.port | default(51820) }}"
wireguard_interface: "wg0"
wireguard_server_ip: "{{ wireguard.server_ip | default('10.0.0.1') }}"
wireguard_client_ip: "{{ wireguard.client_ip | default('10.0.0.2') }}"
wireguard_client_public_key: "{{ wireguard.client_public_key | default('') }}"

# Network configuration (from config.yml: network.*)
home_caddy_port: "{{ network.home_caddy_port | default(8080) }}"

# =============================================================================
# BANDWIDTH MONITORING CONFIGURATION
# =============================================================================
# These map from the nested bandwidth_monitor.* structure in config.yml

# Master enable/disable switch
bandwidth_monitor_enabled: "{{ bandwidth_monitor.enabled | default(false) }}"

# Azure Budget API configuration  
azure_budget_name: "{{ bandwidth_monitor.azure_budget_name | default('Monthly-Bandwidth-Limit') }}"
fallback_budget: "{{ bandwidth_monitor.fallback_budget | default(150.00) }}"

# Throttling thresholds (percentage of budget)
# 3-tier system: high, medium, disabled
bandwidth_thresholds:
  high: "{{ bandwidth_monitor.thresholds.high | default(50) }}"
  disabled: "{{ bandwidth_monitor.thresholds.disabled | default(90) }}"

# Bandwidth limits (bits per second)
# 3-tier system: high (4 Mbps), medium (2 Mbps), disabled (0)
bandwidth_limits:
  high: "{{ bandwidth_monitor.limits.high | default(4000000) }}"
  medium: "{{ bandwidth_monitor.limits.medium | default(2000000) }}"
  disabled: "{{ bandwidth_monitor.limits.disabled | default(0) }}"

# =============================================================================
# JELLYFIN CONFIGURATION
# =============================================================================
# Only used when bandwidth_monitor.enabled = true
# Values are derived from other config sections to avoid duplication

jellyfin_subdomain: "{{ jellyfin.subdomain | default('jellyfin') }}"
jellyfin_hostname: "{{ jellyfin_subdomain }}.{{ domain.name }}"
jellyfin_host: "{{ wireguard.client_ip | default('10.0.0.2') }}"
jellyfin_port: "{{ home_caddy_port }}"
jellyfin_api_key: "{{ jellyfin.api_key | default(lookup('env', 'JELLYFIN_API_KEY')) }}"

# =============================================================================
# SYSTEM DEFAULTS (Not typically overridden by config.yml)
# =============================================================================

# Timezone
system_timezone: "UTC"

# Caddy configuration
caddy_version: "latest"
caddy_user: "caddy"
caddy_group: "caddy"
caddy_config_dir: "/etc/caddy"
caddy_certs_dir: "/etc/caddy/certs"
caddy_log_dir: "/var/log/caddy"
caddy_memory_max: "100M"

# Bandwidth monitor paths
bandwidth_monitor_dir: "/opt/bandwidth-monitor"
bandwidth_monitor_log: "/var/log/bandwidth-monitor.log"
bandwidth_monitor_state: "/var/lib/bandwidth-monitor/state.json"
bandwidth_monitor_interval: "hourly"

# Certificate sync configuration
certsync_user: "certsync"
certsync_incoming_dir: "/home/{{ certsync_user }}/incoming"
certsync_certs_dir: "{{ caddy_certs_dir }}"
cert_fullchain_file: "fullchain.pem"
cert_privkey_file: "privkey.pem"

# Firewall defaults
ufw_default_incoming: "deny"
ufw_default_outgoing: "allow"

firewall_allowed_tcp_ports:
  - 443  # HTTPS

firewall_allowed_udp_ports:
  - "{{ wireguard_port }}"

# Fail2ban configuration
fail2ban_bantime: 3600
fail2ban_findtime: 600
fail2ban_maxretry: 3

# Automatic security updates
unattended_upgrades_enabled: true
unattended_upgrades_auto_reboot: false

# Base system packages
base_packages:
  - curl
  - jq
  - htop
  - net-tools
  - python3
  - python3-pip
  - python3-venv

# =============================================================================
# KERNEL HARDENING
# =============================================================================

sysctl_config:
  # IP Forwarding (required for WireGuard)
  net.ipv4.ip_forward: 1
  
  # Ignore ICMP ping
  net.ipv4.icmp_echo_ignore_all: 1
  
  # SYN flood protection
  net.ipv4.tcp_syncookies: 1
  net.ipv4.tcp_max_syn_backlog: 2048
  net.ipv4.tcp_synack_retries: 2
  
  # Disable source packet routing
  net.ipv4.conf.all.accept_source_route: 0
  net.ipv4.conf.default.accept_source_route: 0
  
  # Ignore redirects
  net.ipv4.conf.all.accept_redirects: 0
  net.ipv4.conf.all.send_redirects: 0
  net.ipv4.conf.default.accept_redirects: 0
  net.ipv4.conf.default.send_redirects: 0
  
  # Log suspicious packets
  net.ipv4.conf.all.log_martians: 1
