---
# Common Role - Base System Setup
# Handles base packages, system configuration, and users

- name: Set timezone
  timezone:
    name: "{{ system_timezone }}"

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Upgrade all packages
  apt:
    upgrade: dist
    autoremove: yes
    autoclean: yes

- name: Install base packages
  apt:
    name: "{{ base_packages }}"
    state: present

- name: Install unattended-upgrades
  apt:
    name: unattended-upgrades
    state: present
  when: unattended_upgrades_enabled

- name: Apply kernel hardening parameters
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.d/99-hardening.conf
    reload: yes
  loop: "{{ sysctl_config | dict2items }}"

- name: Configure unattended upgrades
  template:
    src: 51myunattended-upgrades.j2
    dest: /etc/apt/apt.conf.d/51myunattended-upgrades
    owner: root
    group: root
    mode: '0644'
  when: unattended_upgrades_enabled

- name: Enable unattended upgrades
  command: dpkg-reconfigure -f noninteractive unattended-upgrades
  when: unattended_upgrades_enabled
  changed_when: false

- name: Disable root password
  user:
    name: root
    password_lock: yes

- name: Ensure admin user exists with sudo access
  user:
    name: "{{ ssh.admin_username }}"
    groups: sudo
    append: yes
    state: present

- name: Display common role completion
  debug:
    msg:
      - "Common role tasks completed"
      - "Base packages installed"
      - "Kernel hardening applied"
      - "Unattended upgrades: {{ 'enabled' if unattended_upgrades_enabled else 'disabled' }}"
