#cloud-config
# Azure WireGuard Secure Tunnel - Cloud-Init Bootstrap
# This script runs on first boot to configure the VM

package_update: true
package_upgrade: true

packages:
  - wireguard
  - wireguard-tools
  - ufw
  - fail2ban
  - curl
  - jq
  - htop
  - net-tools

write_files:
  # WireGuard server configuration (from template)
  - path: /etc/wireguard/wg0.conf
    permissions: '0600'
    content: |
      ${azure_wireguard_config}

  # Caddy systemd service
  - path: /etc/systemd/system/caddy.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Caddy Web Server
      Documentation=https://caddyserver.com/docs/
      After=network.target network-online.target
      Requires=network-online.target
      
      [Service]
      Type=notify
      User=caddy
      Group=caddy
      ExecStart=/usr/bin/caddy run --config /etc/caddy/Caddyfile
      ExecReload=/usr/bin/caddy reload --config /etc/caddy/Caddyfile --force
      TimeoutStopSec=5s
      LimitNOFILE=1048576
      PrivateTmp=true
      ProtectSystem=full
      AmbientCapabilities=CAP_NET_BIND_SERVICE
      MemoryMax=100M
      
      [Install]
      WantedBy=multi-user.target

  # Caddyfile configuration (from template)
  - path: /etc/caddy/Caddyfile
    permissions: '0644'
    content: |
      ${azure_caddyfile_content}

  # Fail2Ban jail configuration
  - path: /etc/fail2ban/jail.local
    permissions: '0644'
    content: |
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 3
      
      [sshd]
      enabled = true
      port = 22
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 3
      bantime = 3600

  # UFW configuration script
  - path: /usr/local/bin/configure-firewall.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e
      
      # Reset UFW
      ufw --force reset
      
      # Default policies
      ufw default deny incoming
      ufw default allow outgoing
      
      # Allow SSH from home IPv4
      ufw allow from ${allowed_ssh_ipv4} to any port 22 proto tcp comment 'SSH from home IPv4'
      
      # Allow SSH from home IPv6 (if configured)
%{ if allowed_ssh_ipv6 != "" ~}
      ufw allow from ${allowed_ssh_ipv6} to any port 22 proto tcp comment 'SSH from home IPv6'
%{ endif ~}
      
      # Allow HTTPS from anywhere
      ufw allow 443/tcp comment 'HTTPS'
      
      # Allow WireGuard
      ufw allow ${wireguard_port}/udp comment 'WireGuard'
      
      # Enable UFW
      ufw --force enable

  # DNS update script (runs on boot)
  - path: /usr/local/bin/update-dns.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e
      
      # Get current public IP
      CURRENT_IP=$(curl -s --max-time 10 ifconfig.me || curl -s --max-time 10 icanhazip.com)
      
      if [ -z "$CURRENT_IP" ]; then
        echo "Failed to get public IP"
        exit 1
      fi
      
      # Extract domain parts
      DOMAIN="${domain_name}"              # e.g., "svc.example.com"
      SUBDOMAIN="${subdomain}"             # e.g., "*"
      BASE_DOMAIN=$(echo "$DOMAIN" | rev | cut -d'.' -f1-2 | rev)  # e.g., "example.com"
      
      # Extract intermediate parts (everything except last 2 parts)
      # For "svc.example.com", this extracts "svc"
      # For "jellyfin.svc.example.com", this extracts "jellyfin.svc"
      INTERMEDIATE=$(echo "$DOMAIN" | rev | cut -d'.' -f3- | rev)
      
      # Combine subdomain with intermediate parts
      if [ -z "$INTERMEDIATE" ]; then
        # No intermediate parts (domain is just "example.com")
        FULL_SUBNAME="$SUBDOMAIN"
      else
        # Has intermediate parts (domain is "svc.example.com" or deeper)
        FULL_SUBNAME="$SUBDOMAIN.$INTERMEDIATE"
      fi
      
      # Update deSEC DNS
      # This creates: *.svc.example.com (subname="*.svc" on domain="example.com")
      curl -X PATCH "https://desec.io/api/v1/domains/$BASE_DOMAIN/rrsets/" \
        -H "Authorization: Token ${desec_token}" \
        -H "Content-Type: application/json" \
        -d "[{\"subname\": \"$FULL_SUBNAME\", \"type\": \"A\", \"records\": [\"$CURRENT_IP\"], \"ttl\": 3600}]"
      
      # Log the update
      logger "DNS updated: $FULL_SUBNAME.$BASE_DOMAIN -> $CURRENT_IP"
      echo "DNS updated: $FULL_SUBNAME.$BASE_DOMAIN -> $CURRENT_IP"

  # DNS update systemd service (one-shot on boot)
  - path: /etc/systemd/system/dns-update.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Update DNS on boot
      After=network-online.target
      Wants=network-online.target
      
      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/update-dns.sh
      RemainAfterExit=yes
      
      [Install]
      WantedBy=multi-user.target

  # Kernel hardening parameters
  - path: /etc/sysctl.d/99-hardening.conf
    permissions: '0644'
    content: |
      # IP Forwarding (required for WireGuard)
      net.ipv4.ip_forward = 1
      
      # Ignore ICMP ping
      net.ipv4.icmp_echo_ignore_all = 1
      
      # SYN flood protection
      net.ipv4.tcp_syncookies = 1
      net.ipv4.tcp_max_syn_backlog = 2048
      net.ipv4.tcp_synack_retries = 2
      
      # Disable source packet routing
      net.ipv4.conf.all.accept_source_route = 0
      net.ipv4.conf.default.accept_source_route = 0
      
      # Ignore redirects
      net.ipv4.conf.all.accept_redirects = 0
      net.ipv4.conf.all.send_redirects = 0
      net.ipv4.conf.default.accept_redirects = 0
      net.ipv4.conf.default.send_redirects = 0
      
      # Log suspicious packets
      net.ipv4.conf.all.log_martians = 1

  # SSH hardening
  - path: /etc/ssh/sshd_config.d/99-hardening.conf
    permissions: '0644'
    content: |
      # Password authentication disabled
      PasswordAuthentication no
      PermitEmptyPasswords no
      ChallengeResponseAuthentication no
      
      # Public key authentication only
      PubkeyAuthentication yes
      
      # No root login
      PermitRootLogin no
      
      # Session settings
      MaxAuthTries 3
      MaxSessions 2
      ClientAliveInterval 300
      ClientAliveCountMax 2
      
      # Disable X11 and TCP forwarding
      X11Forwarding no
      AllowTcpForwarding no

  # SSH SFTP-only configuration for certsync user
  - path: /etc/ssh/sshd_config.d/80-certsync-sftp.conf
    permissions: '0644'
    content: |
      # Certificate sync user - SFTP only (no shell access)
      Match User certsync
          ForceCommand internal-sftp
          PermitTTY no
          X11Forwarding no
          AllowTcpForwarding no

  # Certificate processing script
  - path: /usr/local/bin/process-certs.sh
    permissions: '0755'
    content: |
      ${process_certs_script}

  # Systemd path watcher for certificate changes
  - path: /etc/systemd/system/certsync-watcher.path
    permissions: '0644'
    content: |
      [Unit]
      Description=Watch for certificate uploads
      Documentation=https://github.com/SamEvansTurner/azure-wireguard-tunnel
      
      [Path]
      PathChanged=/home/certsync/incoming
      Unit=certsync-processor.service
      
      [Install]
      WantedBy=multi-user.target

  # Systemd service to process certificates
  - path: /etc/systemd/system/certsync-processor.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Process uploaded certificates
      Documentation=https://github.com/SamEvansTurner/azure-wireguard-tunnel
      After=network.target
      
      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/process-certs.sh
      StandardOutput=journal
      StandardError=journal
      SyslogIdentifier=certsync
      
      # Security hardening
      PrivateTmp=yes
      NoNewPrivileges=yes
      ProtectSystem=strict
      ProtectHome=read-only
      ReadWritePaths=/etc/caddy/certs /home/certsync/incoming
      
      [Install]
      WantedBy=multi-user.target

runcmd:
  # Create caddy user FIRST (before any services that need it)
  - useradd -r -s /bin/false -d /var/lib/caddy -m caddy 2>/dev/null || true

  # Install Caddy
  - |
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee /etc/apt/sources.list.d/caddy-stable.list
    apt-get update
    apt-get install -y caddy

  # Create certsync user (limited permissions, no sudo)
  - useradd -r -m -s /usr/sbin/nologin -c "Certificate Sync User" certsync
  - mkdir -p /home/certsync/incoming
  - chown certsync:certsync /home/certsync/incoming
  - chmod 700 /home/certsync/incoming

  # Create directories
  - mkdir -p /etc/caddy/certs
  - mkdir -p /var/log/caddy
  - mkdir -p /etc/caddy
  - mkdir -p /home/caddy/.local/share/caddy
  - mkdir -p /home/caddy/.config/caddy
  - chown -R caddy:caddy /var/log/caddy /etc/caddy/certs /home/caddy
  - chmod 755 /etc/caddy/certs /home/caddy

  # Generate WireGuard keys
  - umask 077
  - wg genkey | tee /etc/wireguard/privatekey | wg pubkey > /etc/wireguard/publickey
  - chmod 600 /etc/wireguard/privatekey
  - chmod 644 /etc/wireguard/publickey
  
  # Update WireGuard config with generated private key
  - |
    PRIVATE_KEY=$(cat /etc/wireguard/privatekey)
    sed -i "s|{{WIREGUARD_SERVER_PRIVATE_KEY}}|$PRIVATE_KEY|" /etc/wireguard/wg0.conf

  # Apply kernel hardening
  - sysctl -p /etc/sysctl.d/99-hardening.conf

  # Configure firewall
  - /usr/local/bin/configure-firewall.sh

  # Disable root password
  - passwd -l root

  # Enable and start services
  - systemctl daemon-reload
  - systemctl enable wg-quick@wg0
  - systemctl start wg-quick@wg0
  - systemctl enable fail2ban
  - systemctl enable dns-update.service
  - systemctl enable certsync-watcher.path
  - systemctl start fail2ban
  - systemctl start dns-update.service
  - systemctl start certsync-watcher.path

  # Configure automatic security updates
  - |
    apt-get install -y unattended-upgrades
    echo 'Unattended-Upgrade::Automatic-Reboot "false";' > /etc/apt/apt.conf.d/51myunattended-upgrades
    dpkg-reconfigure -f noninteractive unattended-upgrades

  # Note: WireGuard and Caddy will be started manually after configuration

final_message: |
  Cloud-init bootstrap complete!
  
  Next steps:
  1. Add certsync SSH public key to /home/certsync/.ssh/authorized_keys
  2. Copy your SSL certificates to /etc/caddy/certs/ (or use cert sync)
  3. Update WireGuard peer configuration with home public key
  4. Start WireGuard: systemctl start wg-quick@wg0
  5. Start Caddy: systemctl start caddy
  
  Certificate sync is ready:
  - User: certsync
  - Upload to: /home/certsync/incoming/
  - Processed to: /etc/caddy/certs/
  - Systemd watcher will auto-process certificates
  
  Server is ready for secure tunnel operations.
